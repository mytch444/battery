#!/bin/bash

MESSAGEFILE="/tmp/lowbatteryd-`find /tmp -name \"lowbatteryd-*\" | wc -l`"
LOW=10
VERYLOW=3

function low {
    notify-send -t 5 "Get To The Power!"
}

function verylow {
    notify-send -t 10 "NOOOWWW!!!!"
}

function check {
    DELAY=$1
    if [ -z $DELAY ]; then
	DELAY=20
    fi

    touch "$MESSAGEFILE"
    
    while :
    do
	MESSAGE=`cat "$MESSAGEFILE"`
	if [ "$MESSAGE" == "STOP" ]; then
	    break
	fi

	STATE=`battery -s`
	if [ "$STATE" == "Charging" ]; then
	    MESSAGE="CHARGING"
	fi
	
	BATTERY=`battery -c`
	if [ $BATTERY -lt $VERYLOW ] && [ -z "$MESSAGE" ]; then
	    verylow
	    echo "VERYLOW" > "$MESSAGEFILE"
	elif [ $BATTERY -lt $LOW ] && [ -z "$MESSAGE" ]; then
	    low
	    echo "LOW" > "$MESSAGEFILE"
	fi
	
	sleep $DELAY
    done

    rm "$MESSAGEFILE"
    echo "Stopped lowbatteryd"
}

if [ "$1" == "-h" ]; then
    echo "$0 [n]"
    echo "   Will check the battery percentage every n (20 if not given) seconds. If it is below 10 it will show a message, if below 3 a different message."
    echo "$0 stop"
    echo "   Will create a file in /tmp that will cause the daemon to stop next time it goes to check the percentage."
    echo "$0 -h"
    echo "   Will give you this."
elif [ "$1" == "stop" ]; then
    echo "Stopping lowbatteryd"
    echo "STOP" > "$MESSAGEFILE"
else
    echo "Starting lowbatteryd"
    check "$1" &
fi
