. $CONF

function checkloop {
	echo 0 > "$LEVELFILE"

	while :
	do
		# No harm in reloading config.
		. $CONF

		sleep $DELAY

		if [[ "`battery -s`" == "Charging" ]]; then
			echo 0 > "$LEVELFILE"
			continue
		fi
		
		L=`cat $LEVELFILE`

		BAT=`battery -c`
		if [ $BAT -le $EXTREMELOW ] && [[ $L -lt 3 ]]; then
			
			echo 3 > $LEVELFILE
			/bin/sh -c "$EXTREMELOWCOMMAND"

		elif [ $BAT -le $VERYLOW ] && [[ $L -lt 2 ]]; then
		
			echo 2 > $LEVELFILE
			/bin/sh -c "$VERYLOWCOMMAND"

		elif [ $BAT -le $LOW ] && [[ $L -lt 1 ]]; then
	
			echo 1 > $LEVELFILE
			/bin/sh -c "$LOWCOMMAND"

		fi
	done

    rm "$LEVELFILE"
}

if [ "$1" == "-h" ]; then
    echo "$0"
	echo "	Starts monitoring (non-forking)."	
    echo "$0 -h"
    echo "	Prints this."
	echo
	echo "lowbatteryd is a simple bash script that checks the battery charge and executes commands at certain levels"
	echo "The interval time, levels and commands can be changed in /etc/lowbatteryd"

else
    checkloop
fi
